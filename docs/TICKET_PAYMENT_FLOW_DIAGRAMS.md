# ğŸ“Š Diagramas de Flujos - TicketPayment

**VisualizaciÃ³n de Flujos**: Estados, transiciones y decisiones
**VersiÃ³n**: 1.0

---

## 1. Flujo General de Tiquete a Pago

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TICKET CREADO  â”‚
â”‚    (ACTIVE)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€ Sorteo se ejecuta
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TICKET EVALUADO â”‚ â† Solo ganadores continÃºan aquÃ­
â”‚   (EVALUATED)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€ Â¿Es ganador?
         â”‚  NO â†’ CANCELLED
         â”‚  YES â†“
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                            â”‚                      â”‚
         â†“                            â†“                      â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  PAGO   â”‚           â”‚  PAGO PARCIAL    â”‚    â”‚ PAGO MÃšLTIPLE    â”‚
    â”‚ COMPLETOâ”‚           â”‚  (UNA ENTREGA)   â”‚    â”‚   (MÃšLTIPLES)    â”‚
    â”‚ ($100)  â”‚           â”‚   ($30 de $100)  â”‚    â”‚    ($30 + $70)   â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                         â”‚                        â”‚
         â”‚ Registrar               â”‚                        â”‚
         â”‚ amountPaid=$100         â”‚                        â”‚
         â”‚                         â”‚ Registrar              â”‚
         â”‚                         â”‚ amountPaid=$30         â”‚
         â”‚                         â”‚ isFinal=false          â”‚
         â”‚                         â”‚                        â”‚
         â†“                         â†“                        â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
    â”‚  PAID   â”‚â—„â”€â”€â”€â”€â”€â”   â”‚   EVALUADO       â”‚             â”‚
    â”‚ (status)â”‚  YES â”‚   â”‚  (status)        â”‚             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   â”‚  Pending Payment â”‚             â”‚
                     â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
                     â”‚            â”‚                       â”‚
                     â”‚            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
                     â”‚            â”‚             â”‚         â”‚
                     â”‚     Â¿MÃºltiples pagos?    â”‚         â”‚
                     â”‚            â”‚             â”‚         â”‚
                     â”‚       NO â”€â”€â”˜             â”‚         â”‚
                     â”‚       â”‚                  â”‚         â”‚
                     â”‚       â”‚ Finalizar        â”‚         â”‚
                     â”‚       â”‚ (isFinal=true)   â”‚ Pago siguiente
                     â”‚       â”‚ O pago exacto    â”‚ o parcial final
                     â”‚       â”‚                  â”‚         â”‚
                     â”‚       â†“                  â†“         â”‚
                     â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
                     â””â”€â”€â”€â”‚  PAID   â”‚      â”‚ EVALUATEDâ—„â”€â”€â”€â”˜
                         â”‚ (parcial)     â”‚ (pendiente)
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â–²               â”‚
                             â”‚ Pagar resto   â”‚
                             â”‚ exacto O      â”‚
                             â”‚ final         â”‚
                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TRANSICIONES FINALES:                                  â”‚
â”‚ - EVALUATED â†’ PAID: DespuÃ©s de pago completo          â”‚
â”‚ - PAID â†’ EVALUATED: Solo si se revierte pago          â”‚
â”‚ - Pago parcial: Ticket NO cambia a PAID (pendiente)   â”‚
â”‚ - Pago parcial + isFinal: Ticket â†’ PAID (aceptado)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. MÃ¡quina de Estados - TicketPayment

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   TICKET PAYMENT CREATED    â”‚
                    â”‚                             â”‚
                    â”‚  isReversed: false          â”‚
                    â”‚  isFinal: false             â”‚
                    â”‚  completedAt: null          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                     â”‚
                    â†“                     â†“
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  PARTIAL PAY    â”‚  â”‚  FULL PAY    â”‚
            â”‚                 â”‚  â”‚              â”‚
            â”‚ isPartial: true â”‚  â”‚ isPartial:   â”‚
            â”‚ isFinal: false  â”‚  â”‚ false        â”‚
            â”‚ completedAt:    â”‚  â”‚ completedAt: â”‚
            â”‚   null          â”‚  â”‚   NOW        â”‚
            â”‚ Ticket: EVAL    â”‚  â”‚ Ticket: PAID â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚                    â–²
                     â”‚                    â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”œâ”€ Registrar otro pago
              â”‚  (rechazado â†’ error 409)
              â”‚
              â”œâ”€ Pago exacto del resto
              â”‚  ($70 final de $100)
              â”‚  â†“
              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  â”‚  FULL PAY       â”‚
              â”‚  â”‚  (Completado)   â”‚
              â”‚  â”‚  Ticket: PAID   â”‚
              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”œâ”€ Pago parcial + isFinal
              â”‚  ($50 de $100)
              â”‚  isFinal: true
              â”‚  â†“
              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  â”‚  PARTIAL FINAL  â”‚
              â”‚  â”‚                 â”‚
              â”‚  â”‚ isPartial: true â”‚
              â”‚  â”‚ isFinal: true   â”‚
              â”‚  â”‚ completedAt:    â”‚
              â”‚  â”‚   NOW           â”‚
              â”‚  â”‚ Ticket: PAID    â”‚
              â”‚  â”‚ (con deuda)     â”‚
              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â””â”€ Revertir pago
                 â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  REVERSED        â”‚
              â”‚                  â”‚
              â”‚ isReversed: true â”‚
              â”‚ Ticket: EVAL     â”‚
              â”‚ (vuelve atrÃ¡s)   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. DecisiÃ³n: Â¿Pago Parcial o Completo?

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /ticket-payments              â”‚
â”‚ {                                  â”‚
â”‚   ticketId: "xxx"                  â”‚
â”‚   amountPaid: ???                  â”‚
â”‚ }                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                         â”‚
        â†“                         â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Calcular        â”‚    â”‚ totalPayout =  â”‚
   â”‚ totalPayout     â”‚    â”‚ suma(jugadas   â”‚
   â”‚ (jugadas        â”‚    â”‚ ganadoras)     â”‚
   â”‚ ganadoras)      â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
            â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ Ejemplo: totalPayout = 100
            â”‚
       â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
       â”‚          â”‚
    amountPaid < totalPayout?
       â”‚          â”‚
      NO         YES
       â”‚          â”‚
       â†“          â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚Completoâ”‚   â”‚ Parcial  â”‚
   â”‚(100â‰¡100)  â”‚ (50<100) â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
        â”‚            â”‚
        â”‚     Â¿isFinal?
        â”‚     â”‚       â”‚
        â”‚    YES      NO
        â”‚     â”‚       â”‚
        â”‚     â†“       â†“
        â”‚  â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”
        â”‚  â”‚PAIDâ”‚  â”‚EVAL  â”‚
        â”‚  â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ PAID   â”‚
    â”‚ Status â”‚
    â”‚Changed â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. Flujo de Error: MÃºltiples Parciales

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Primer pago: $30 parcial registrado             â”‚
â”‚ Ticket.status: EVALUATED                        â”‚
â”‚ TicketPayment.isFinal: false                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /ticket-payments (segundo intento)         â”‚
â”‚ {                                               â”‚
â”‚   ticketId: "same-ticket"                       â”‚
â”‚   amountPaid: 40                                â”‚
â”‚ }                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backend busca:                                  â”‚
â”‚ .findFirst({                                   â”‚
â”‚   ticketId: xxx,                               â”‚
â”‚   isReversed: false,                           â”‚
â”‚   isFinal: false  â† AÃšN NO FINALIZADO          â”‚
â”‚ })                                             â”‚
â”‚                                                 â”‚
â”‚ Encuentra: TicketPayment (isFinal=false)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ERROR 409 - CONFLICT                  â”‚
    â”‚ TKT_PAY_005                           â”‚
    â”‚ "Ya existe un pago parcial pendiente" â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
    â”‚               â”‚
    â†“               â†“
 SOLUCIÃ“N 1     SOLUCIÃ“N 2
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ Pagar    â”‚  â”‚ Finalizar pago   â”‚
 â”‚ exacto   â”‚  â”‚ anterior PATCH    â”‚
 â”‚ ($70)    â”‚  â”‚ + nuevo pago     â”‚
 â”‚          â”‚  â”‚ (parcial o final)â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚               â”‚
      â†“               â†“
   PAID            EVALUATED/PAID
```

---

## 5. Flujo de ReversiÃ³n

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Pago Registrado y PAID                 â”‚
â”‚                                        â”‚
â”‚ TicketPayment.isReversed: false       â”‚
â”‚ TicketPayment.completedAt: 2025-10-28â”‚
â”‚ Ticket.status: PAID                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /ticket-payments/:id/reverse      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TRANSACCIÃ“N:                           â”‚
â”‚ 1. Marcar TicketPayment.isReversed=trueâ”‚
â”‚ 2. Si Ticket.status === PAID:         â”‚
â”‚    Revertir a EVALUATED                â”‚
â”‚ 3. Registrar quiÃ©n y cuÃ¡ndo            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST-REVERSIÃ“N:                        â”‚
â”‚                                        â”‚
â”‚ TicketPayment.isReversed: true        â”‚
â”‚ TicketPayment.reversedAt: NOW         â”‚
â”‚ TicketPayment.reversedBy: user-id    â”‚
â”‚ Ticket.status: EVALUATED              â”‚
â”‚ (Vuelve pendiente de pago)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Puede registrar      â”‚
    â”‚ nuevo pago al ticket â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. Flujo de Idempotencia

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /ticket-payments                        â”‚
â”‚ {                                            â”‚
â”‚   ticketId: "xxx"                           â”‚
â”‚   amountPaid: 50                            â”‚
â”‚   idempotencyKey: "pago-ticket-001"         â”‚
â”‚ }                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Buscar por key   â”‚
        â”‚ idempotencyKey = â”‚
        â”‚ "pago-ticket-001"â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
         â”‚               â”‚
       FOUND          NOT FOUND
         â”‚               â”‚
         â†“               â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚Retornar â”‚      â”‚Crear   â”‚
    â”‚anterior â”‚      â”‚nuevo   â”‚
    â”‚(201)    â”‚      â”‚(201)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
         â”‚                â”‚
         â”‚ Mismo pago ID  â”‚ Nuevo pago ID
         â”‚                â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Frontend recibe 201             â”‚
  â”‚ No duplica pago si reintenta    â”‚
  â”‚ Â¡Idempotente! âœ…               â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. Secuencia: Pago Parcial MÃºltiple

```
Timeline: T1, T2, T3

T1: Primera entrega
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /ticket-payments           â”‚
â”‚ amountPaid: 30 de 100           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ TicketPayment#1  â”‚
        â”‚ amountPaid: 30   â”‚
        â”‚ isPartial: true  â”‚
        â”‚ isFinal: false   â”‚
        â”‚ completedAt: nullâ”‚
        â”‚ Ticket: EVAL     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


T2: Intento de segunda entrega inmediata
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /ticket-payments           â”‚
â”‚ amountPaid: 40 de 100           â”‚
â”‚ (sin isFinal)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
        âŒ ERROR 409
        TKT_PAY_005
        "Pago parcial pendiente"


T3: Finalizar con segundo pago
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /ticket-payments                â”‚
â”‚ amountPaid: 70                       â”‚
â”‚ isFinal: true  â† MARCA COMO FINAL   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ TicketPayment#2  â”‚
        â”‚ amountPaid: 70   â”‚
        â”‚ isPartial: true  â”‚
        â”‚ isFinal: true    â”‚
        â”‚ completedAt: NOW â”‚
        â”‚ Ticket: PAID     â”‚â—„â”€â”€ Cambio!
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


HISTORIAL FINAL:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TicketPayment #1                    â”‚
â”‚ - $30 - parcial - no final - null   â”‚
â”‚                                     â”‚
â”‚ TicketPayment #2                    â”‚
â”‚ - $70 - parcial - final - 2025-10-28â”‚
â”‚                                     â”‚
â”‚ TOTAL PAGADO: $100                  â”‚
â”‚ TICKET STATUS: PAID (con deuda: $0) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. Matriz de DecisiÃ³n: QuÃ© Ocurre en Cada Caso

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  MATRIZ DE DECISIÃ“N                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ amountPaid      â”‚isPartial â”‚isFinal   â”‚ Status â”‚Ticket  â”‚AcciÃ³n â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ = totalPayout   â”‚ false    â”‚ false    â”‚201     â”‚ PAID   â”‚Listo  â”‚
â”‚ (ej: 100=100)   â”‚          â”‚ (ignored)â”‚        â”‚(auto)  â”‚       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ < totalPayout   â”‚ true     â”‚ false    â”‚201     â”‚ EVAL   â”‚Pendto â”‚
â”‚ (ej: 30<100)    â”‚          â”‚          â”‚        â”‚(pendte)â”‚       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ < totalPayout   â”‚ true     â”‚ true     â”‚201     â”‚ PAID   â”‚Final  â”‚
â”‚ (ej: 50<100)    â”‚          â”‚          â”‚        â”‚(aceptdoâ”‚parcialâ”‚
â”‚ + isFinal       â”‚          â”‚          â”‚        â”‚deuda)  â”‚       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ exacto resto    â”‚ false    â”‚ false    â”‚201     â”‚ PAID   â”‚Auto-  â”‚
â”‚ (despues 30+70) â”‚          â”‚ (ignored)â”‚        â”‚(auto)  â”‚compl  â”‚
â”‚ = totalPayout   â”‚          â”‚          â”‚        â”‚        â”‚       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ > totalPayout   â”‚ N/A      â”‚ N/A      â”‚400     â”‚ N/A    â”‚Rechzo â”‚
â”‚ (ej: 150>100)   â”‚          â”‚          â”‚        â”‚        â”‚       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ existe parcial  â”‚ N/A      â”‚ N/A      â”‚409     â”‚ N/A    â”‚Bloq   â”‚
â”‚ sin cerrar      â”‚          â”‚          â”‚        â”‚        â”‚       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤

Notas:
- status = HTTP response code
- Ticket status = Ticket.status despuÃ©s de operaciÃ³n
- isFinal en pago completo es ignorado (no aplica)
- Pago parcial bloquea segundo intento hasta finalizaciÃ³n
```

---

## 9. Flujo de Roles y AutorizaciÃ³n

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /ticket-payments                â”‚
â”‚ + Authorization: Bearer <token>      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Extraer role    â”‚
        â”‚ del JWT token   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚          â”‚          â”‚
     ADMIN    VENTANA    VENDEDOR
      â”‚          â”‚          â”‚
      â†“          â†“          â†“
    âœ…          âœ…          âŒ
    SÃ­          SÃ­          NO
   Crear       Crear       Crear
   pagos       pagos        pagos
   cualquier   su
   tiquete     ventana

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VENTANA ESPECÃFICO:                â”‚
â”‚                                    â”‚
â”‚ Ticket.ventanaId !== JWT.ventanaId?â”‚
â”‚            â”‚                       â”‚
â”‚           YES                      â”‚
â”‚            â”‚                       â”‚
â”‚            â†“                       â”‚
â”‚   âŒ 403 RBAC_001                 â”‚
â”‚   "No autorizado para esta ventana"â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 10. Secuencia Temporal Completa

```
Timeline completa de un tiquete con mÃºltiples pagos:

00:00 - Tiquete creado
        Ticket.status = ACTIVE

01:00 - Sorteo se ejecuta
        Ticket evaluado como ganador
        Ticket.status = EVALUATED
        Ticket.isWinner = true
        totalPayout = 100

02:00 - Primer pago ($30)
        POST /ticket-payments
        âœ… TicketPayment#1 creado
           amountPaid: 30
           isPartial: true
           completedAt: null
        ğŸ“ Ticket.status = EVALUATED (sin cambios)

02:30 - Intento de segundo pago sin cerrar ($40)
        POST /ticket-payments
        âŒ ERROR 409 TKT_PAY_005
        "Debe finalizar pago anterior"

03:00 - Finalizar pago 1 + hacer pago 2 ($70 final)
        POST /ticket-payments
        + isFinal: true
        âœ… TicketPayment#2 creado
           amountPaid: 70
           isFinal: true
           completedAt: 2025-10-28T03:00:00Z
        ğŸ“ Ticket.status = PAID â† Â¡CAMBIO!

03:30 - Revisar historial
        GET /tickets/xxx/payment-history

        Respuesta:
        {
          totalPayout: 100,
          totalPaid: 100,
          remainingAmount: 0,
          ticketStatus: "PAID",
          payments: [
            { amountPaid: 30, isPartial: true, isFinal: false, ... },
            { amountPaid: 70, isPartial: true, isFinal: true, ... }
          ]
        }

04:00 - Detectan error en segundo pago
        POST /ticket-payments/:id/reverse

        âœ… TicketPayment#2 revertido
           isReversed: true
           reversedAt: 2025-10-28T04:00:00Z
        ğŸ“ Ticket.status = EVALUATED â† Vuelve atrÃ¡s

04:30 - Pago correcto ($70)
        POST /ticket-payments
        + isFinal: true
        âœ… TicketPayment#3 creado
        ğŸ“ Ticket.status = PAID â† De nuevo

05:00 - Fin
        Tiquete completamente pagado
```

---

## Resumen Visual

| Flujo | Complejidad | Casos |
|-------|------------|-------|
| Pago Completo | â­ Baja | 1 POST â†’ PAID |
| Pago Parcial Ãšnico | â­â­ Media | 1 POST â†’ EVAL (pendiente) |
| MÃºltiples Parciales | â­â­â­ Alta | Bloqueo + finalizaciÃ³n |
| ReversiÃ³n | â­â­ Media | POST reverse â†’ estado anterior |
| Idempotencia | â­â­â­ Alta | Retry-safe con key |

---

**Todos los flujos son:**
âœ… AtÃ³micos (transaccionalidad Prisma)
âœ… Auditados (ActivityService)
âœ… RBAC-protegidos
âœ… Validados estrictamente
âœ… Production-ready

