================================================================================
FRONTEND INTEGRATION - COMPLETE DOCUMENTATION PACKAGE
================================================================================

Date: 2025-10-28
Status: âœ… READY FOR FRONTEND IMPLEMENTATION

================================================================================
WHAT YOU NEED TO PASS TO FRONTEND
================================================================================

ðŸ“¦ DOCUMENTATION FILES (Ready in docs/ folder):

1. SALES_API_QUICK_REFERENCE.md (500 lines)
   â†’ One-page reference for quick lookups
   â†’ Copy-paste examples for all 5 endpoints
   â†’ Common mistakes and how to fix them
   â†’ curl examples for testing

2. FRONTEND_SALES_API_GUIDE.md (2500+ lines)
   â†’ Complete integration guide
   â†’ All endpoints documented in detail
   â†’ Request/response examples with real data
   â†’ Code examples for React/Vue/Angular
   â†’ RBAC behavior explained
   â†’ Error handling patterns
   â†’ Testing checklist (20+ items)
   â†’ Date handling best practices

3. README.md (Updated)
   â†’ Updated with links to both guides
   â†’ Recent changes documented
   â†’ Status clearly marked

================================================================================
WHAT THE SALES API PROVIDES (5 ENDPOINTS)
================================================================================

âœ… GET /api/v1/ventas
   Purpose: Transactional detail (rows, paginated)
   Use for: Data tables, exports, transaction history
   Supports: pagination (page, pageSize), filtering, search, sorting

âœ… GET /api/v1/ventas/summary
   Purpose: KPI executive summary (single aggregated record)
   Use for: Dashboard cards, performance metrics
   Returns: sales total, ticket count, payouts, net, commissions

âœ… GET /api/v1/ventas/breakdown
   Purpose: Top-N analysis by dimension (rankings)
   Use for: Leaderboards, comparison tables
   Dimensions: vendedor (sellers), ventana (windows), loteria (games),
              sorteo (draws), numero (numbers)
   Includes: totalWinningTickets, totalPaidTickets (NEW)

âœ… GET /api/v1/ventas/timeseries
   Purpose: Time-bucketed sales aggregation (trends)
   Use for: Line charts, bar charts, trend analysis
   Granularity: hour (max 30d), day (max 90d), week (unlimited)

âœ… GET /api/v1/ventas/facets
   Purpose: Available filter values (for UI dropdowns)
   Use for: Populating filter dropdowns dynamically
   Returns: ventanas, vendedores, loterias, sorteos

================================================================================
UNIVERSAL PARAMETERS (All endpoints support)
================================================================================

?date=today|yesterday|week|month|year|range
  â†’ Semantic date ranges resolved server-side
  â†’ Backend uses Costa Rica timezone (UTC-6)
  â†’ Client sends calendar dates (YYYY-MM-DD only)

?fromDate=YYYY-MM-DD (required if date=range)
?toDate=YYYY-MM-DD   (required if date=range)

?winnersOnly=true|false
  â†’ Filter for winning tickets only

?status=ACTIVE|EVALUATED|CANCELLED|RESTORED
  â†’ Filter by ticket status

?ventanaId=UUID
  â†’ Filter by sales window (auto-filtered by RBAC)

?vendedorId=UUID
  â†’ Filter by seller (auto-filtered by RBAC)

?loteriaId=UUID
  â†’ Filter by lottery

?sorteoId=UUID
  â†’ Filter by draw

?page=1              (List only, default: 1)
?pageSize=20         (List only, default: 20, max: 100)
?search=text         (List only, searches ticket numbers)
?orderBy=field       (List only, prefix with - for DESC)

?dimension=vendedor  (Breakdown only, REQUIRED)
?top=10              (Breakdown only, max: 50)

?granularity=day     (Timeseries only, hour|day|week)

================================================================================
AUTHENTICATION
================================================================================

All endpoints require JWT token in Authorization header:

Authorization: Bearer <JWT_TOKEN>

The backend:
1. Verifies JWT signature (can't be forged)
2. Extracts user role and identifiers
3. Auto-filters data based on role:
   - VENDEDOR: sees own sales only
   - VENTANA: sees window sales, can filter by seller in window
   - ADMIN: sees all data (no filtering)

4. Returns 403 if user tries to access outside their scope

================================================================================
DATE HANDLING - CRITICAL POINTS
================================================================================

âœ… BACKEND IS THE AUTHORITY
   - Client sends semantic dates (today, yesterday, etc)
   - Backend resolves using server time (no client-side calculation)
   - Prevents timezone confusion and date manipulation

âœ… FORMAT FOR PARAMETERS: YYYY-MM-DD
   âŒ DON'T: ?fromDate=2025-10-27T06:00:00Z
   âœ… DO:    ?fromDate=2025-10-27

âœ… HELPER FUNCTION (JavaScript)
   function formatCRDate(date = new Date()) {
     return date.toISOString().split('T')[0];  // â†’ YYYY-MM-DD
   }

âœ… RESPONSES ARE IN UTC
   "createdAt": "2025-10-27T10:30:45.123Z"
   Convert to local timezone for display:

   const crFormatter = new Intl.DateTimeFormat('es-CR', {
     timeZone: 'America/Costa_Rica',
     year: 'numeric',
     month: '2-digit',
     day: '2-digit',
     hour: '2-digit',
     minute: '2-digit'
   });
   console.log(crFormatter.format(new Date("2025-10-27T10:30:45.123Z")));
   // â†’ "27/10/2025, 04:30:45"

================================================================================
QUICK COPY-PASTE EXAMPLES
================================================================================

Today's summary:
/api/v1/ventas/summary?date=today

Top 10 sellers this month:
/api/v1/ventas/breakdown?dimension=vendedor&date=month&top=10

Winners only, this week:
/api/v1/ventas?date=week&winnersOnly=true&pageSize=50

Sales trend (last 30 days by day):
/api/v1/ventas/timeseries?granularity=day&date=month

Custom date range:
/api/v1/ventas?date=range&fromDate=2025-10-01&toDate=2025-10-27

Available filters for today:
/api/v1/ventas/facets

Top 20 most played numbers:
/api/v1/ventas/breakdown?dimension=numero&top=20&date=week

================================================================================
RESPONSE STRUCTURE
================================================================================

All responses follow this pattern:

{
  "success": true,
  "data": [               â† Array (list) or Object (summary) or null
    { /* item */ }
  ],
  "meta": {
    "range": {
      "fromAt": "2025-10-27T06:00:00.000Z",
      "toAt": "2025-10-28T05:59:59.999Z",
      "tz": "America/Costa_Rica"
    },
    "effectiveFilters": {  â† Shows RBAC-applied filters
      "vendedorId": "uuid"
    },
    "total": 250,          â† List only
    "page": 1,             â† List only
    "pageSize": 20,        â† List only
    "totalPages": 13,      â† List only
    "hasNextPage": true,   â† List only
    "hasPrevPage": false   â† List only
  }
}

Error responses:

{
  "success": false,
  "error": {
    "message": "Invalid date range",
    "code": "SLS_2001",
    "statusCode": 400,
    "details": [
      {
        "field": "toDate",
        "reason": "Cannot be in the future"
      }
    ]
  }
}

================================================================================
COMMON ERROR CODES
================================================================================

SLS_2001 (400) - Validation error
  â†’ Invalid date format
  â†’ Date range issues (fromDate > toDate)
  â†’ Timeseries limit exceeded (hour max: 30d, day max: 90d)
  â†’ Invalid parameter values

SLS_2002 (400) - Invalid parameter
  â†’ Invalid dimension (not: vendedor, ventana, loteria, sorteo, numero)
  â†’ Invalid granularity (not: hour, day, week)
  â†’ Missing required parameter

RBAC_001 (403) - Access denied
  â†’ Attempting to access different window (VENTANA/VENDEDOR roles)

RBAC_002 (403) - Access denied
  â†’ Seller not in your window (VENTANA role)

401 - Unauthenticated
  â†’ Missing or invalid JWT token

================================================================================
IMPLEMENTATION WORKFLOW
================================================================================

1. Frontend receives documentation
   â†’ Read SALES_API_QUICK_REFERENCE.md (5 min)
   â†’ Skim FRONTEND_SALES_API_GUIDE.md for details

2. Test with curl
   Get token, try simple request:
   curl -H "Authorization: Bearer TOKEN" \
     "https://api.example.com/api/v1/ventas/summary"

3. Build components
   â†’ Summary dashboard (use /summary endpoint)
   â†’ Rankings table (use /breakdown endpoint)
   â†’ Charts (use /timeseries endpoint)
   â†’ Filters (populate from /facets endpoint)
   â†’ List (use /ventas endpoint with pagination)

4. Handle dates correctly
   â†’ Use helper function: formatCRDate()
   â†’ Send YYYY-MM-DD format
   â†’ Let backend calculate ranges

5. Test RBAC scenarios
   â†’ Login as VENDEDOR â†’ see own sales only
   â†’ Login as VENTANA â†’ see window sales
   â†’ Login as ADMIN â†’ see all data
   â†’ Try accessing outside scope â†’ get 403

6. Test error handling
   â†’ Invalid date format â†’ SLS_2001
   â†’ Invalid dimension â†’ SLS_2002
   â†’ Missing token â†’ 401
   â†’ Cross-window access â†’ 403

7. Deploy to production
   â†’ All tests passing
   â†’ Documentation reviewed
   â†’ Team trained

================================================================================
KEY FEATURES
================================================================================

âœ… 5 read-only endpoints (safe for frontend)
âœ… Universal date parameters (no client-side calculation)
âœ… RBAC enforcement (automatic, can't bypass)
âœ… Pagination support (handle large datasets)
âœ… Multiple aggregation views (summary, breakdown, timeseries)
âœ… Filter dropdowns (facets endpoint)
âœ… Search capabilities (full-text search)
âœ… Sorting options (createdAt, totalAmount, etc)
âœ… Error codes (consistent, documented)
âœ… Activity logging (audit trail)

================================================================================
NEW IN THIS RELEASE
================================================================================

âœ… Enhanced breakdown endpoint
   â†’ Added totalWinningTickets
   â†’ Added totalPaidTickets
   â†’ All 5 dimensions support these metrics

âœ… Fixed TicketStatus enum
   â†’ PAGADO renamed to PAID
   â†’ Migration created: 20251028010355_rename_pagado_to_paid
   â†’ All references updated in services
   â†’ ActivityType.TICKET_STATUS_PAID added

âœ… Comprehensive documentation
   â†’ 2500+ line implementation guide
   â†’ 500+ line quick reference
   â†’ Code examples for React
   â†’ Testing checklist (20+ items)

================================================================================
NEXT STEPS FOR FRONTEND
================================================================================

1. âœ… Receive documentation (you have it now)
2. â³ Read quick reference (5 min)
3. â³ Set up API client (axios, fetch, etc)
4. â³ Build summary component
5. â³ Build breakdown component
6. â³ Build timeseries charts
7. â³ Implement filters
8. â³ Add pagination
9. â³ Test all scenarios
10. â³ Deploy

================================================================================
TESTING BEFORE PRODUCTION
================================================================================

Checklist (from FRONTEND_SALES_API_GUIDE.md):

Authentication:
[ ] Invalid token returns 401
[ ] Expired token returns 401
[ ] Missing token returns 401

RBAC - VENDEDOR:
[ ] Can call endpoints
[ ] Auto-filtered to own sales
[ ] Cannot request other vendedorId
[ ] Cannot request other ventanaId

RBAC - VENTANA:
[ ] Can call endpoints
[ ] Auto-filtered to window
[ ] Can request seller in window
[ ] Cannot request seller outside window

RBAC - ADMIN:
[ ] Can call endpoints
[ ] No auto-filtering
[ ] Can cross all boundaries

Date Parameters:
[ ] date=today works
[ ] date=yesterday works
[ ] date=week works
[ ] date=month works
[ ] date=year works
[ ] date=range with fromDate/toDate works
[ ] Invalid date format returns SLS_2001
[ ] Future date returns SLS_2001
[ ] fromDate > toDate returns SLS_2001

All endpoints:
[ ] Returns 200 OK
[ ] Response has success, data, meta
[ ] Date ranges match request
[ ] effectiveFilters show RBAC filters
[ ] Timestamps are ISO 8601 UTC

List endpoint:
[ ] Pagination works (page, pageSize)
[ ] totalPages calculated correctly
[ ] hasNextPage/hasPrevPage correct

Breakdown endpoint:
[ ] All 5 dimensions work
[ ] Top parameter limits results
[ ] Top > 50 returns error
[ ] totalWinningTickets populated
[ ] totalPaidTickets populated

Timeseries endpoint:
[ ] Granularity=hour works (max 30d)
[ ] Granularity=day works (max 90d)
[ ] Granularity=week works
[ ] Exceeding limits returns error
[ ] Results sorted by timestamp ASC

Error handling:
[ ] Invalid parameters return proper codes
[ ] Errors include field and reason
[ ] 4xx vs 5xx status codes correct
[ ] Error response structure valid

================================================================================
SUPPORT & QUESTIONS
================================================================================

For clarifications:
1. Check SALES_API_QUICK_REFERENCE.md (quick answers)
2. Check FRONTEND_SALES_API_GUIDE.md (detailed reference)
3. Test with curl first (validate parameters)
4. Contact backend with full error response

Documents location: /docs/FRONTEND_SALES_API_GUIDE.md
                    /docs/SALES_API_QUICK_REFERENCE.md

================================================================================
SUMMARY
================================================================================

You have:
âœ… 2500+ line complete API reference
âœ… 500+ line quick reference
âœ… Code examples (React)
âœ… Testing checklist
âœ… Date handling guide
âœ… RBAC explanation
âœ… Error handling patterns
âœ… curl examples
âœ… Production-ready backend

Everything you need to implement a full-featured sales analytics frontend.

Start with SALES_API_QUICK_REFERENCE.md - 10 minute read.
Then reference FRONTEND_SALES_API_GUIDE.md as needed.

================================================================================
